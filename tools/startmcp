#!/usr/bin/env bash

set -euo pipefail

# Function to display usage
usage() {
    echo "Usage: $0 <project_name>"
    echo ""
    echo "Creates a new UV-based MCP (Model Context Protocol) server project"
    echo ""
    echo "Arguments:"
    echo "  project_name        Name of the MCP project to create"
    echo ""
    echo "Options:"
    echo "  --help             Show this help message"
    echo "  --llm              Show LLM usage documentation"
    echo ""
    echo "Examples:"
    echo "  $0 my-mcp-server"
    echo "  $0 data-processor"
    echo ""
    echo "The project will be created in ~/python/<project_name>/"
}

# Function to display LLM usage documentation
llm_usage() {
    echo "=== LLM Usage Documentation for startmcp ==="
    echo ""
    echo "PURPOSE:"
    echo "  Creates a complete MCP (Model Context Protocol) server project"
    echo "  using UV for Python dependency management and FastMCP framework"
    echo ""
    echo "USAGE:"
    echo "  $0 <project_name>"
    echo ""
    echo "PARAMETERS:"
    echo "  project_name: Name for the MCP server project"
    echo ""
    echo "BEHAVIOR:"
    echo "  - Creates project directory in ~/python/<project_name>/"
    echo "  - Initializes UV project with virtual environment"
    echo "  - Installs MCP server dependencies (mcp, pytest-asyncio, pytest, etc.)"
    echo "  - Creates main.py with FastMCP server template"
    echo "  - Creates config.py with dotenv configuration"
    echo "  - Generates Makefile with common development commands"
    echo "  - Sets up .env and .env.local files"
    echo "  - Creates .gitignore with Python/UV-specific exclusions"
    echo "  - Creates .mcp.json configuration file"
    echo "  - Creates .claude/commands directory"
    echo "  - Automatically launches Claude Code in the new project"
    echo ""
    echo "GENERATED FILES:"
    echo "  - main.py: FastMCP server entry point"
    echo "  - config.py: Environment configuration"
    echo "  - Makefile: Development commands (lint, format, test, etc.)"
    echo "  - .env/.env.local: Environment variables"
    echo "  - .gitignore: Git exclusions"
    echo "  - .mcp.json: MCP server configuration"
    echo "  - pyproject.toml: UV project configuration"
    echo ""
    echo "MAKEFILE COMMANDS:"
    echo "  - make lint: Run ruff check"
    echo "  - make format: Run black formatter"
    echo "  - make test: Run pytest with auto parallelization"
    echo "  - make test-fast: Run non-slow tests"
    echo "  - make test-slow: Run slow tests only"
    echo "  - make check: Run all quality checks"
    echo "  - make start: Start the MCP server"
    echo ""
    echo "REQUIREMENTS:"
    echo "  - UV must be installed and available in PATH"
    echo "  - Python 3.11+ recommended"
    echo "  - Write permissions in ~/python/ directory"
    echo ""
    echo "POST-CREATION:"
    echo "  - Automatically activates virtual environment"
    echo "  - Launches Claude Code in the project directory"
    echo "  - Ready for MCP server development"
    exit 0
}

# Check for help flags
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    usage
    exit 0
fi

# Check for LLM flag
if [ "$1" = "--llm" ]; then
    llm_usage
fi

if [[ $# -lt 1 ]]; then
    echo "Error: Please provide a project name"
    usage
    exit 1
fi

proj="$1"
# replace with your preferred location of python projects
BASE="$HOME/python"

# 1. ensure python directory exists, then scaffold
mkdir -p "$BASE"
cd "$BASE"
uv init "$proj"

# 2. enter project, create a standard .venv, activate it
cd "$proj"
uv venv
source .venv/bin/activate

# 3. install MCP server dependencies and testing tools
for pkg in mcp pytest-asyncio pytest pytest-xdist python-dotenv; do
  uv pip install "$pkg"
done

rm main.py

# create .claude/commands directory
mkdir -p .claude/commands

cat > config.py <<EOF
from dotenv import load_dotenv
import os


class Config:
    # Load .env first, then .env.local (which will override .env values)
    load_dotenv()  # Load .env
    load_dotenv('.env.local', override=True)  # Load .env.local with override

    def __init__(self) -> None:
        self.port = os.getenv("PORT")
EOF

cat > main.py <<EOF
import mcp
from mcp.server.fastmcp import FastMCP, Context

mcp = FastMCP("$proj")

def main():
    mcp.run(transport="stdio")


if __name__ == "__main__":
    main()
EOF

# 4. create a Makefile in the project dir
echo "-> creating Makefile"

cat > .mcp.json <<EOF
{
	"mcpServers": {
		"collect": {
			"command": "/Users/benjaminmetz/.local/bin/uv",
			"args": [
				"--directory",
				"/Users/benjaminmetz/python/collect",
				"run",
				"collect.py"
			]
		}
	}
}
EOF


cat > Makefile <<EOF
PROJECT_NAME := $proj

lint:
	ruff check .

format:
	black .

test: 
	uv run pytest -v -s -n auto

test-fast:
	uv run pytest -v -n auto -m "not slow"

test-slow:
	uv run pytest -v -s -m slow

export-pip:
	uv pip freeze > requirements.txt

check:
	make lint
	make format
	make test
	make export-pip

start:
	python main.py

create-kernal:
	python -m ipykernel install --user --name \$(PROJECT_NAME) --display-name "Python 3.11 (\$(PROJECT_NAME))"

setup:
	pip install -r requirements.txt
EOF

cat > .env <<EOF
PORT=8081
GCP_PROJECT_ID=YOURGCPPROJECTIDHERE
EOF

cat > .env.local <<EOF
# Local environment variables - this file is typically gitignored
# Override any .env values here for local development
# PORT=8082
EOF

cat > .gitignore <<EOF
# Python-generated files
__pycache__/
*.py[oc]
build/
dist/
wheels/
*.egg-info

# Virtual environments
.venv
venv/
env/

# Environment variables
.env.local
.env.*.local

# IDE and editor files
.vscode/
.idea/
*.swp
*.swo
*~

# OS generated files
.DS_Store
.DS_Store?
._*
.Spotlight-V100
.Trashes
ehthumbs.db
Thumbs.db

# Test coverage
.coverage
htmlcov/
.pytest_cache/
.tox/

# Temporary files
:w
*.tmp
*.temp

# Python version management
.python-version

# UV lock file (optional - some prefer to track this)
# uv.lock
EOF

echo
echo "✅  UV MCP project '$proj' created in '$BASE/$proj'"
echo "✅  Makefile generated"
echo
echo "→ launching Claude Code…"

# 5. launch claude in the project dir
claude
